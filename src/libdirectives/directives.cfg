//* vim: filetype=txt: formatoptions-=c: formatoptions-=r: formatoptions-=o: syntax=m4

//*  ===========================================================================
//*                              Directive Aliases
//*  ===========================================================================
//*  This script provides aliases that sort of function like the C preprocessor
//*  directives. Supported features are listed below.
//*
//*  1 - Macro Definition:
//*        Define macros with #define, which will essentially be a cvar holding
//*        the contents to be substituted with. After defining a macro it can be
//*        used anywhere in the config file by expanding the macro just like how
//*        cvars are expanded ($<cvar>). One practical example is the "_rpn_not"
//*        macro used in this very script. For that see the note at the bottom
//*        of the script.
//*        One other example would be an rpn expression macro that checks if the
//*        item on the rpn stack is a null string.
//*
//*          #define NULL 65535 // taking crc16 of null string gives 65535
//*          #define ISNULL "crc16 ${NULL} =="   // check if the item on the stack
//*                                              // is null string.
//*
//*        Defined macros can be deleted with #undef, which essentially unsets the
//*        cvar.
//*
//*  2 - File inclusion:
//*        This directive simply executes a file only if the said file exists. This
//*        doesn't throw any error message if the file doesn't exist. That can be
//*        customized by changing "__svm_directive_include_error" alias.
//*
//*        Example:
//*          #include stackvm-xonotic/examples/mainloader.cfg
//*
//*  3 - #ifdef and #ifndef with #else block and #endif:
//*
//*        #ifdef and #ifndef take cvar name, the cvar should contain
//*        positive integer for the if code block to execute. Empty
//*        cvars are considered not defined. In case of #ifdef if code
//*        block is executed when the cvar contains positive integer
//*        value greater than zero, otherwise the else block is executed.
//*        It's opposite for #ifndef.
//*
//*        Example:
//*          #ifndef _MATHCFG
//*          d #define _MATHCFG 1
//*          d label square
//*          d s dup
//*          d s mul
//*          d s ret
//*          #else
//*          d echo math.cfg already included
//*          #endif
//*
//*        NOTE: the "d" alias is used to send the section following
//*        it to the respective code block, so it isn't executed when
//*        the file is executed.
//*
//*  4 - #if with #else block and #endif:
//*        #if is similar to #ifdef and #ifndef the only difference is
//*        that #if takes rpn expression as an input instead of a cvar name.
//*        For a practical example of #if see the notice below, where _rpn_not
//*        is determined based on the version of xonotic running.


//* TODO: explain this mess.
//* Somewhat Immutable Cvar?? :)
define(IMUTCVAR, `set $1 $2; alias $1 "set $1 $2" define($1, $2)')
define(VERSION, `IMUTCVAR($1_VERSION, $1_VERSION_MAJOR.$1_VERSION_MINOR.$1_VERSION_PATCH)')

include(libdirectives/version.m4)
IMUTCVAR(LIBDIRECTIVES_VERSION_MAJOR, __libdirectives_major__)
IMUTCVAR(LIBDIRECTIVES_VERSION_MINOR, __libdirectives_minor__)
IMUTCVAR(LIBDIRECTIVES_VERSION_PATCH, __libdirectives_patch__)

VERSION(LIBDIRECTIVES)

define(MACRODEF, `alias #$1 "$2"')

//* #define & #undef
MACRODEF(`define', `set ${1 !} \"${2- ?}\"')
MACRODEF(`undef', `unset ${1 !}')

//* #include
MACRODEF(`include', `rpn \"/__c_include_do\" \"/exec ${1 !}\" \"/__a_include_nexists\" \"/${1 !}\" fexists when =; __a_include_do')
alias __a_include_do "${__c_include_do !}"
alias __a_include_nexists ""

//* Now comparision directives can be nested, but the inner most directive will run first.
//* #FIX: Make #if, #ifdef, #ifndef execute commands sequencially.
//*#TODO: Add stack underflow gaurd
alias __a_stack_create "rpn \"/${1 !}.pointer\" 0 put"
alias __a_stack_push "rpn \"/${1 !}.pointer\" dup get \"/${1 !}.%s\" sprintf1s ${2 !} put dup get 1 + put;"
alias __a_stack_pop "rpn \"/${2 !}\" \"/${1 !}.pointer\" dup dup get 1 - put get \"/${1 !}.%s\" sprintf1s get =;"

define(CREATE_STACK, `__a_stack_create $1')
define(STACK_PUSH, `__a_stack_push $1 $2')
define(STACK_PUSH_CVAR, `__a_stack_push $1 \"/$2 load\"')
define(STACK_POP, `__a_stack_pop $1 $2')

define(__dstack__, __libdirectives_stack__)
CREATE_STACK(__dstack__)

//* Store if else code blobs.
set __c_directive_if_blob     ""
set __c_directive_else_blob   ""
set __c_directive_action      "__a_append_to_if_blob"
set __c_preprocessor_action   ""

alias __a_append_to_if_blob   "__c_directive_if_blob \"${__c_directive_if_blob};${1- !}\""
alias __a_append_to_else_blob "__c_directive_else_blob \"${__c_directive_else_blob};${1- !}\""
alias __a_run_if_blob         "${__c_directive_if_blob}"
alias __a_run_else_blob       "${__c_directive_else_blob}"
alias __a_reset_state         "__c_directive_if_blob \"\"; __c_directive_else_blob \"\"; __c_preprocessor_action \"__a_append_to_if_blob\";"
alias __a_push_blobs          "STACK_PUSH_CVAR(__dstack__, __c_directive_if_blob); STACK_PUSH_CVAR(__dstack__, __c_directive_else_blob); STACK_PUSH_CVAR(__dstack__, __c_preprocessor_action); STACK_PUSH_CVAR(__dstack__, __c_directive_action);"
alias __a_pop_blobs           "STACK_POP(__dstack__, __c_directive_action);STACK_POP(__dstack__, __c_preprocessor_action); STACK_POP(__dstack__, __c_directive_else_blob); STACK_POP(__dstack__, __c_directive_if_blob);"

//* Redirect input to directive blobs
alias @ "${__c_directive_action !} ${1- q}"

//* #If <rpn-expression>
MACRODEF(`if', `__a_push_blobs; __a_reset_state; rpn /__c_preprocessor_action /__a_run_if_blob /__a_run_else_blob ${1- ?} when =')

//* #NOTE: In #ifdef & #ifndef, the cvar must contain some value to be considered defined.
//*        Empty cvars are considered not defined.
//* #ifdef <cvar>
MACRODEF(`ifdef', `__a_push_blobs; __a_reset_state; rpn /__c_preprocessor_action /__a_run_if_blob /__a_run_else_blob \"/${1 !}\" load crc16 65535 != when =')

//* #ifndef <cvar>
MACRODEF(`ifndef', `__a_push_blobs; __a_reset_state; rpn /__c_preprocessor_action /__a_run_if_blob /__a_run_else_blob \"/${1 !}\" load crc16 65535 == when =')

//*#TODO: add support for #elseif
MACRODEF(`else', `__c_directive_action \"__a_append_to_else_blob\"')
MACRODEF(`endif', `${__c_preprocessor_action ?}; __a_pop_blobs')

//* Some predefined macros

//* If script was loaded by the client, __CLIENT__ will be defined.
if_client #define __CLIENT__ 1

//* If script was loaded by the server, __DEDICATED__ will be defined.
if_dedicated #define __DEDICATED__ 1
